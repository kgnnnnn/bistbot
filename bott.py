import time
import random
import os
import re
import requests
import yfinance as yf
from io import BytesIO
from flask import Flask, request
from threading import Thread
from PyPDF2 import PdfReader
import openai
import xml.etree.ElementTree as ET
import pandas as pd
from bs4 import BeautifulSoup
import html
from concurrent.futures import ThreadPoolExecutor
from datetime import datetime, timedelta

openai.api_key = os.getenv("OPENAI_API_KEY")
print("DEBUG OPENAI KEY:", openai.api_key[:10] if openai.api_key else "YOK", flush=True)

BOT_TOKEN = "8116276773:AAHoSQAthKmijTE62bkqtGQNACf0zi0JuCs"
URL = f"https://api.telegram.org/bot{BOT_TOKEN}/"

# =============== TELEGRAM ===============
def get_updates(offset=None):
    try:
        r = requests.get(URL + "getUpdates", params={"timeout": 100, "offset": offset}, timeout=100)
        return r.json()
    except Exception as e:
        print("get_updates error:", e, flush=True)
        return {}

def send_message(chat_id, text):
    try:
        requests.post(
            URL + "sendMessage",
            params={"chat_id": chat_id, "text": text, "parse_mode": "HTML", "disable_web_page_preview": True},
            timeout=10,
        )
    except Exception as e:
        print("Send error:", e, flush=True)


# =============== SAYI BÄ°Ã‡Ä°MLENDÄ°RME ===============
def format_number(num):
    """SayÄ±larÄ± 12.345.678 formatÄ±nda dÃ¶ndÃ¼rÃ¼r."""
    try:
        if num in (None, "â€”"):
            return None
        if isinstance(num, str):
            num = num.replace(".", "").replace(",", "")
            if not num.isdigit():
                return None
            num = int(num)
        return f"{int(num):,}".replace(",", ".")
    except Exception:
        return None


# =============== HABERLER (Google RSS) ===============
import xml.etree.ElementTree as ET

def get_news(symbol):
    """Google News RSS Ã¼zerinden hisseye ait son 3 haberi dÃ¶ndÃ¼rÃ¼r."""
    try:
        url = f"https://news.google.com/rss/search?q={symbol}+Borsa+Ä°stanbul+OR+hisse&hl=tr&gl=TR&ceid=TR:tr"
        r = requests.get(url, timeout=10)
        if r.status_code != 200:
            return "ğŸ“° Haberler alÄ±namadÄ±."

        xml_data = r.text.encode("utf-8", "ignore").decode("utf-8", "ignore")
        xml_data = xml_data.replace("&", "&amp;")

        root = ET.fromstring(xml_data)
        items = root.findall(".//item")[:3]
        if not items:
            return "ğŸ“° LÃ¼tfen hisse kodunu doÄŸru giriniz. (Ã–rn: ASELS)"

        haberler = ["ğŸ—ï¸ <b>Son Haberler</b>"]
        for item in items:
            title = (item.find("title").text or "").strip()
            link = (item.find("link").text or "").strip()
            pub = (item.find("pubDate").text or "").split("+")[0].strip() if item.find("pubDate") is not None else ""
            haberler.append(f"ğŸ”¹ <a href='{link}'>{title}</a> ({pub})")

        return "\n".join(haberler)

    except Exception as e:
        print("get_news hata:", e, flush=True)
        return "ğŸ“° Haberler alÄ±namadÄ±."


# =============== HABER ANALÄ°ZÄ° (OpenAI - Kriptos AI) ===============
def analyze_news_with_ai(news_text):
    try:
        api_key = os.getenv("OPENAI_API_KEY")
        if not api_key:
            return "âš ï¸ AI yorum yapÄ±lamadÄ± (API anahtarÄ± eksik)."
        if "Haberler alÄ±namadÄ±" in news_text or "LÃ¼tfen" in news_text:
            return "âš ï¸ GeÃ§erli haber bulunamadÄ±."

        prompt = (
            "AÅŸaÄŸÄ±da Borsa Ä°stanbul'da iÅŸlem gÃ¶ren bir hisseye ait son haber baÅŸlÄ±klarÄ± bulunuyor.\n"
            "Bu baÅŸlÄ±klarÄ± analiz et; 1-2 cÃ¼mlelik kÄ±sa bir TÃ¼rkÃ§e Ã¶zet oluÅŸtur ve genel piyasa hissiyatÄ±nÄ± belirt (pozitif / negatif / nÃ¶tr).\n"
            "YatÄ±rÄ±m tavsiyesi verme.\n"
            "YanÄ±tÄ±nÄ± 'ğŸ¤– <b>Kriptos AI Yorum:</b>' etiketiyle baÅŸlat.\n\n"
            f"{news_text}"
        )

        r = requests.post(
            "https://api.openai.com/v1/chat/completions",
            headers={"Authorization": f"Bearer {api_key}", "Content-Type": "application/json"},
            json={"model": "gpt-4o-mini", "messages": [{"role": "user", "content": prompt}], "max_tokens": 120},
            timeout=15,
        )
        if r.status_code != 200:
            return "âš ï¸ AI yorum alÄ±namadÄ±."
        data = r.json()
        msg = data.get("choices", [{}])[0].get("message", {}).get("content")
        return msg.strip() if msg else "âš ï¸ AI yorum alÄ±namadÄ±."
    except Exception as e:
        print("AI yorum hatasÄ±:", e, flush=True)
        return "âš ï¸ AI yorum alÄ±namadÄ±."


# =============== YAHOO FÄ°YAT ===============
def get_price(symbol):
    """Yahoo Finance Ã¼zerinden fiyat, aÃ§Ä±lÄ±ÅŸ, kapanÄ±ÅŸ, tavan, taban bilgilerini Ã§eker."""
    try:
        time.sleep(random.uniform(0.3, 0.6))
        ticker = yf.Ticker(symbol.upper() + ".IS")
        info = ticker.info
        if not info or not info.get("currentPrice"):
            return None
        return {
            "fiyat": info.get("currentPrice"),
            "acilis": info.get("open"),
            "kapanis": info.get("previousClose"),
            "tavan": info.get("dayHigh"),
            "taban": info.get("dayLow"),
        }
    except Exception as e:
        print("get_price hata:", e, flush=True)
        return None


# =============== TRADINGVIEW (RSI, EMA50/EMA200) ===============
TV_URL = "https://tradingview-real-time.p.rapidapi.com/technicals/summary"
TV_HEADERS = {
    "x-rapidapi-key": "1749e090ffmsh612a371009ddbcap1c2f2cjsnaa23aba94831",
    "x-rapidapi-host": "tradingview-real-time.p.rapidapi.com",
}

def get_tv_analysis(symbol):
    try:
        r = requests.get(TV_URL, headers=TV_HEADERS, params={"query": symbol.upper()}, timeout=8)
        data = r.json().get("data", {})
        return {"rsi": data.get("RSI"), "ema50": data.get("EMA50"), "ema200": data.get("EMA200")}
    except Exception as e:
        print("get_tv_analysis hata:", e, flush=True)
        return None


def map_rsi_label(rsi):
    """RSI deÄŸerine gÃ¶re sinyal dÃ¶ndÃ¼rÃ¼r."""
    try:
        r = float(rsi)
        r = round(r, 2)
        if r < 20:
            return f"{r} (GÃœÃ‡LÃœ AL)"
        elif r < 30:
            return f"{r} (AL)"
        elif r > 85:
            return f"{r} (GÃœÃ‡LÃœ SAT)"
        elif r > 70:
            return f"{r} (SAT)"
        else:
            return f"{r} (NÃ–TR)"
    except:
        return "NÃ–TR"


def map_ema_signal(ema50, ema200):
    try:
        return "AL" if float(ema50) >= float(ema200) else "SAT"
    except:
        return "NÃ–TR"


def combine_recommendation(ema_sig, rsi_label):
    """EMA ve RSI sinyallerine gÃ¶re Kriptos AI genel yorumu Ã¼retir."""
    if ("AL" in rsi_label or "GÃœÃ‡LÃœ AL" in rsi_label) and ema_sig == "AL":
        return "AL"
    if ("SAT" in rsi_label or "GÃœÃ‡LÃœ SAT" in rsi_label) and ema_sig == "SAT":
        return "SAT"
    return "NÃ–TR"


### BILANCO OZET ###
def get_balance_summary(symbol):
    """Åimdilik pasif: bilanÃ§o Ã¶zeti yakÄ±nda eklenecek."""
    return {"summary": "ğŸ¤– <b>Kriptos AI:</b> Ã‡OK YAKINDA"}


##-------------------------MESAJ OLUÅTURMA-------------------------##
def build_message(symbol):
    symbol = symbol.strip().upper()
    info = get_price(symbol)
    tech = get_tv_analysis(symbol)
    lines = [f"ğŸ’¹ <b>{symbol}</b> Hisse Ã–zeti (BIST100)"]

    # --- Fiyat ---
    if info:
        lines.append(f"ğŸ’° Fiyat: {info['fiyat']} TL")
        if info.get("acilis"):
            lines.append(f"ğŸ“ˆ AÃ§Ä±lÄ±ÅŸ: {info['acilis']}")
        if info.get("kapanis"):
            lines.append(f"ğŸ“‰ KapanÄ±ÅŸ: {info['kapanis']}")
        if info.get("tavan"):
            lines.append(f"ğŸ”¼ Tavan: {info['tavan']}")
        if info.get("taban"):
            lines.append(f"ğŸ”½ Taban: {info['taban']}")

    # --- Teknik Analiz ---
    if tech:
        rsi_val = tech.get("rsi")
        ema50, ema200 = tech.get("ema50"), tech.get("ema200")
        rsi_label = map_rsi_label(rsi_val)
        ema_sig = map_ema_signal(ema50, ema200)
        overall = combine_recommendation(ema_sig, rsi_label)
        lines.append("\nğŸ“Š <b>Teknik Analiz</b>")
        lines.append(f"âš¡ RSI: {rsi_label}")
        lines.append(f"ğŸ”„ EMA(50/200): {ema_sig}")
        lines.append(f"ğŸ¤– <b>Kriptos AI:</b> {overall}")

    # --- BilanÃ§o Ã–zeti ---
    fin = get_balance_summary(symbol)
    if fin and fin.get("summary"):
        lines.append("\nğŸ¦ <b>BilanÃ§o Ã–zeti</b>")
        lines.append(fin["summary"])

    # --- Haberler ---
    news_text = get_news(symbol)
    lines.append("\n" + news_text)
    ai_comment = analyze_news_with_ai(news_text)
    lines.append("\n" + ai_comment)

    lines.append("\n<b>ğŸ’¬ GÃ¶rÃ¼ÅŸ & Ã–neri:</b> @kriptosbtc")
    return "\n".join(lines)


# =============== ANA DÃ–NGÃœ ===============
def main():
    print("ğŸš€ Kriptos Borsa Botu aktif!", flush=True)
    last_update_id = None
    processed = set()
    while True:
        updates = get_updates(last_update_id)
        if not updates:
            time.sleep(0.8)
            continue
        results = updates.get("result", [])
        results.sort(key=lambda x: x.get("update_id", 0))
        for item in results:
            uid = item.get("update_id")
            if uid in processed:
                continue
            processed.add(uid)
            last_update_id = uid + 1
            msg_data = item.get("message", {})
            chat_id = msg_data.get("chat", {}).get("id")
            text = (msg_data.get("text") or "").strip()
            if not chat_id or not text:
                continue
            if text.lower() == "/start":
                msg = (
                    "ğŸ‘‹ <b>Kriptos BIST100 Takip Botu'na HoÅŸ Geldin!</b>\n\n"
                    "ğŸ’¬ Sadece hisse kodunu (Ã¶rnek: ASELS, THYAO...) yazÄ±n.\n\n"
                    "ğŸ’¡  AlgoritmamÄ±z fiyat, gÃ¼ncel haberler, hacim vb. bilgileri iletir.\n\n"
                    "ğŸ¤– Yapay zeka destekli algoritmamÄ±z RSI ve EMA indikatÃ¶r analizleri yapar ve (al-sat-vb.) Ã¶nermeler Ã¼retir.\n\n"
                    "âš™ï¸ Veriler: TradingView & Yahoo Finance'den saÄŸlanmaktadÄ±r.\n\n"
                    "â—ï¸  UYARI: Bilgiler kesinlikle YATIRIM TAVSÄ°YESÄ° kapsamÄ±nda deÄŸildir!\n\n"
                    "ğŸ“Š Komut Ã¶rneÄŸi: <b>ASELS/asels</b>\n\n"
                    "ğŸ“© Sorun veya Ã¶neriler iÃ§in @kriptosbtc ile iletiÅŸime geÃ§ebilirsiniz."
                )
                send_message(chat_id, msg)
                continue
            symbol = text.split()[0].lstrip("/").upper()
            print(f"Gelen istek: {symbol}", flush=True)
            reply = build_message(symbol)
            send_message(chat_id, reply)
            time.sleep(0.8)
        time.sleep(0.5)


# =============== FLASK (Render Portu) ===============
app = Flask(__name__)

@app.route('/')
def home():
    return "âœ… Bot aktif, Render portu aÃ§Ä±k!", 200

def run():
    port = int(os.environ.get("PORT", 8080))
    app.run(host='0.0.0.0', port=port)

Thread(target=run).start()

if __name__ == "__main__":
    main()
